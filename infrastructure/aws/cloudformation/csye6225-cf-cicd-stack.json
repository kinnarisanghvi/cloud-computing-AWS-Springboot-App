{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Cloud formation application file for resources like webapp,db SG and EC2 instance",
   "Parameters":{
      "KeyPairName":{
         "Description":"key pair name",
         "Type":"String"
      },
      "AccountId":{
         "Description":"Account ID",
         "Type":"String"
      },
      "AMIID":{
         "Description":"AMI id",
         "Type":"String"
      },
      "ApplicationName":{
         "Description":"csye6225-webapp",
         "Default":"csye6225-webapp",
         "Type":"String"
      }
   },
   "Resources":{
      "InstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/",
            "Roles":[
               {
                  "Ref":"CodeDeployEC2ServiceRole"
               }
            ]
         }
      },
      "MyEC2Instance":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "ImageId":{
               "Ref":"AMIID"
            },
            "Tags":[
               {
                  "Key":"EC2Name",
                  "Value":"csye6225Spring2019"
               }
            ],
            "KeyName":{
               "Ref":"KeyPairName"
            },
            "InstanceType":"t2.micro",
            "IamInstanceProfile":{
               "Ref":"InstanceProfile"
            },
            "SubnetId":{

               "Ref":"subnetID1"
            },
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "",
                     [
                        "#!/bin/bash -xe\n",
                        "sudo yum -y update\n",
                        "sudo yum install mysql",
                        "sudo systemctl start tomcat.service\n",
                        "sudo systemctl status tomcat.service"
                     ]
                  ]
               }
            },
            "SecurityGroupIds":[
               {
                  "Ref":"csye6225webapp"
               }
            ],
            "BlockDeviceMappings":[
               {
                  "DeviceName":"/dev/sda1",
                  "Ebs":{
                     "DeleteOnTermination":"true",
                     "VolumeSize":"20",
                     "VolumeType":"gp2"
                  }
               }
            ]
         }
      },
      "circleciEC2ami":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "ec2:AttachVolume",
                        "ec2:AuthorizeSecurityGroupIngress",
                        "ec2:CopyImage",
                        "ec2:CreateImage",
                        "ec2:CreateKeypair",
                        "ec2:CreateSecurityGroup",
                        "ec2:CreateSnapshot",
                        "ec2:CreateTags",
                        "ec2:CreateVolume",
                        "ec2:DeleteKeyPair",
                        "ec2:DeleteSecurityGroup",
                        "ec2:DeleteSnapshot",
                        "ec2:DeleteVolume",
                        "ec2:DeregisterImage",
                        "ec2:DescribeImageAttribute",
                        "ec2:DescribeImages",
                        "ec2:DescribeInstances",
                        "ec2:DescribeInstanceStatus",
                        "ec2:DescribeRegions",
                        "ec2:DescribeSecurityGroups",
                        "ec2:DescribeSnapshots",
                        "ec2:DescribeSubnets",
                        "ec2:DescribeTags",
                        "ec2:DescribeVolumes",
                        "ec2:DetachVolume",
                        "ec2:GetPasswordData",
                        "ec2:ModifyImageAttribute",
                        "ec2:ModifyInstanceAttribute",
                        "ec2:ModifySnapshotAttribute",
                        "ec2:RegisterImage",
                        "ec2:RunInstances",
                        "ec2:StopInstances",
                        "ec2:TerminateInstances"
                     ],
                     "Resource":"*"
                  }
               ]
            },
            "Users":[
               "circleci"
            ]
         }
      },
      "CodeDeployEC2S3":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Action":[
                        "s3:Get*",
                        "s3:List*",
                        "s3:Put*",
                        "s3:Delete*"
                     ],
                     "Effect":"Allow",
                     "Resource":"*"
                  }
               ]
            }
         }
      },
      "CircleCIUploadToS3":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:GetObject",
                        "s3:PutObject"
                     ],
                     "Resource":[
                        "*"
                     ]
                  }
               ]
            },
            "Users":[
               "circleci"
            ]
         }
      },
      "CodeDeployEC2ServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "RoleName":"CodeDeployEC2ServiceRole"
         }
      },
      "CodeDeployServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "RoleName":"CodeDeployServiceRole",
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "codedeploy.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
            ]
         }
      },
      "CirlceCICodeDeploy":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:RegisterApplicationRevision",
                        "codedeploy:GetApplicationRevision"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              ":",
                              [
                                 "arn:aws:codedeploy:us-east-1",
                                 {
                                    "Ref":"AccountId"
                                 },
                                 "deploymentconfig:CodeDeployDefault.AllAtOnce"
                              ]
                           ]
                        }
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:CreateDeployment",
                        "codedeploy:GetDeployment"
                     ],
                     "Resource":[
                        "*"
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:GetDeploymentConfig"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              ":",
                              [
                                 "arn:aws:codedeploy:us-east-1",
                                 {
                                    "Ref":"AccountId"
                                 },
                                 "deploymentconfig:CodeDeployDefault.OneAtATime"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              ":",
                              [
                                 "arn:aws:codedeploy:us-east-1",
                                 {
                                    "Ref":"AccountId"
                                 },
                                 "deploymentconfig:CodeDeployDefault.HalfAtATime"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              ":",
                              [
                                 "arn:aws:codedeploy:us-east-1",
                                 {
                                    "Ref":"AccountId"
                                 },
                                 "deploymentconfig:CodeDeployDefault.AllAtOnce"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "Users":[
               "circleci"
            ]
         }
      }
   }
}
