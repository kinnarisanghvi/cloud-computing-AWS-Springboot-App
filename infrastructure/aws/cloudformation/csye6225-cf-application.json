{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Cloud formation application file for resources like webapp,db SG and EC2 instance",
   "Parameters":{
      "KeyPairName":{
         "Description":"key pair name",
         "Type":"String"
      },
      "CodeDeployEC2RoleInstanceProfile":{
         "Description":"Instance Profile",
         "Type":"String"
      },
      "CodeDeployInstanceProfile":{
         "Description":"Code deploy service role",
         "Type":"String"
      },
      "VPCID":{
         "Description":"vpc id",
         "Type":"String"
      },
      "subnetID1":{
         "Description":"subnet id",
         "Type":"String"
      },
      "subnetID2":{
         "Description":"subnet id 2",
         "Type":"String"
      },
      "subnetID3":{
         "Description":"subnet id 3",
         "Type":"String"
      },
      "AMIID":{
         "Description":"AMI id",
         "Type":"String"
      },
      "ApplicationName":{
         "Description":"csye6225-webapp",
         "Default":"csye6225-webapp",
         "Type":"String"
      }
   },
   "Resources":{
      "csye6225webapp":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupName":"csye6225webapp",
            "GroupDescription":"SG for web server",
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"tcp",
                  "FromPort":"22",
                  "ToPort":"22",
                  "CidrIp":"0.0.0.0/0"
               },
               {
                  "IpProtocol":"tcp",
                  "FromPort":"80",
                  "ToPort":"80",
                  "CidrIp":"0.0.0.0/0"
               },
               {
                  "IpProtocol":"tcp",
                  "FromPort":"443",
                  "ToPort":"443",
                  "CidrIp":"0.0.0.0/0"
               }
            ],
            "VpcId":{
               "Ref":"VPCID"
            }
         }
      },
      "csye6225rds":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupName":"db_server_sg",
            "GroupDescription":"SG for DB server",
            "SecurityGroupIngress":{
               "IpProtocol":"tcp",
               "FromPort":"3306",
               "ToPort":"3306",
               "CidrIp":"0.0.0.0/0"
            },
            "VpcId":{
               "Ref":"VPCID"
            }
         }
      },
      "MyEC2Instance":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "ImageId":{
               "Ref":"AMIID"
            },
            "Tags":[
               {
                  "Key":"EC2Name",
                  "Value":"csye6225Spring2019"
               }
            ],
            "KeyName":{
               "Ref":"KeyPairName"
            },
            "InstanceType":"t2.micro",
            "IamInstanceProfile":{
               "Ref":"CodeDeployEC2RoleInstanceProfile"
            },
            "SubnetId":{
               "Ref":"subnetID1"
            },
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "\n",
                     [
                        "#!/bin/bash -xe",
                        "sudo systemctl start tomcat.service",
                        "sudo systemctl status tomcat.service",
                        "sudo systemctl start mysqld",
                        "sudo systemctl status mysqld",
                        "sudo systemctl stop tomcat.service",
                        "sudo echo \"JAVA_OPTS=\\\"\\${JAVA_OPTS} -Dspring.datasource.username=csye6225master -Dspring.datasource.password=csye6225password -Dspring.profiles.active=dev\\\"\" >> /opt/tomcat ",
                        {
                           "Fn::Join": [
                              "",
                              [
                                 "echo 'JAVA_OPTS=\"${JAVA_OPTS} -Dspring.datasource.url=\\\"jdbc:mysql:\\",
                                 {
                                    "Fn:GetAtt": [
                                       "myDBInstance",
                                       "Endpoint.Address"
                                    ]
                                 },
                                 ":3306/csye6225\\\"\"' >> /opt/tomcat"
                              ]
                           ]
                        },
                        "sudo systemctl start tomcat.service",
                        "sudo yum -y update",
                        "sudo touch /tmp/awslogs.conf",
                        "sudo echo '[general]' > /tmp/awslogs.conf",
                        "sudo echo 'state_file=/var/awslogs/agent-state' >> /tmp/awslogs.conf",
                        "sudo echo '[logstream1]' >> /tmp/awslogs.conf",
                        "sudo echo 'file=/var/log/tomcat/csye6225-aws.log' >> /tmp/awslogs.conf",
                        "sudo echo 'log_group_name = csye6225-webapp' >> /tmp/awslogs.conf",
                        "sudo echo 'log_stream_name = csye6225-webapp' >> /tmp/awslogs.conf",
                        "sudo echo 'datetime_format = %d/%b/%Y:%H:%M:%S' >> /tmp/awslogs.conf",
                     ]
                  ]
               }
            },
            "SecurityGroupIds":[
               {
                  "Ref":"csye6225webapp"
               }
            ],
            "BlockDeviceMappings":[
               {
                  "DeviceName":"/dev/sda1",
                  "Ebs":{
                     "DeleteOnTermination":"true",
                     "VolumeSize":"20",
                     "VolumeType":"gp2"
                  }
               }
            ]
         }
      },
      "myDynamoDBTable":{
         "Type":"AWS::DynamoDB::Table",
         "Properties":{
            "AttributeDefinitions":[
               {
                  "AttributeName":"id",
                  "AttributeType":"S"
               }
            ],
            "KeySchema":[
               {
                  "AttributeName":"id",
                  "KeyType":"HASH"
               }
            ],
            "ProvisionedThroughput":{
               "ReadCapacityUnits":"5",
               "WriteCapacityUnits":"5"
            },
            "TableName":"csye6225"
         }
      },
      "myDBSubnet":{
         "Type":"AWS::RDS::DBSubnetGroup",
         "Properties":{
            "DBSubnetGroupDescription":"DB Private Subnet1",
            "SubnetIds":[
               {
                  "Ref":"subnetID1"
               },
               {
                  "Ref":"subnetID2"
               },
               {
                  "Ref":"subnetID3"
               }
            ]
         }
      },
      "myCodeDeploy":{
         "Type":"AWS::CodeDeploy::Application",
         "Properties":{
            "ApplicationName":{
               "Ref":"ApplicationName"
            },
            "ComputePlatform":"Server"
         }
      },
      "myCodeDeplymentGroup":{
         "Type":"AWS::CodeDeploy::DeploymentGroup",
         "Properties":{
            "ApplicationName":{
               "Ref":"ApplicationName"
            },
            "ServiceRoleArn":{
               "Fn::GetAtt":[
                  {
                  "Ref":"CodeDeployInstanceProfile"
                  },
                  "Arn"
               ]
            },
            "AutoRollbackConfiguration":{
               "Enabled":true,
               "Events":[
                  "DEPLOYMENT_FAILURE"
               ]
            },
            "DeploymentConfigName":"CodeDeployDefault.AllAtOnce",
            "DeploymentGroupName":"csye6225-webapp-deployment",
            "DeploymentStyle":{
               "DeploymentOption":"WITHOUT_TRAFFIC_CONTROL",
               "DeploymentType":"IN_PLACE"
            },
            "Ec2TagFilters":[
               {
                  "Key":"EC2Name",
                  "Type":"KEY_AND_VALUE",
                  "Value":"csye6225Spring2019"
               }
            ]
         }
      },
      "myDBInstance":{
         "Type":"AWS::RDS::DBInstance",
         "Properties":{
            "DBName":"csye6225",
            "Engine":"MySQL",
            "EngineVersion":"5.6.34",
            "DBSubnetGroupName":{
               "Ref":"myDBSubnet"
            },
            "AllocatedStorage":"50",
            "MasterUsername":"csye6225master",
            "MasterUserPassword":"csye6225password",
            "MultiAZ":false,
            "DBInstanceClass":"db.t2.medium",
            "PubliclyAccessible":true,
            "DBInstanceIdentifier":"csye6225-spring2019",
            "VPCSecurityGroups":[
               {
                  "Fn::GetAtt":[
                     "csye6225rds",
                     "GroupId"
                  ]
               }
            ]
         }
      }
   }
}
