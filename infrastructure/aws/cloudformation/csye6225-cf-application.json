{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Cloud formation application file for resources like webapp,db SG and EC2 instance",
   "Parameters":{
      "KeyPairName":{
         "Description":"key pair name",
         "Type":"String"
      },
      "AccountId":{
         "Description":"Account ID",
         "Type":"String"
      },
      "VPCID":{
         "Description":"vpc id",
         "Type":"String"
      },
      "subnetID1":{
         "Description":"subnet id",
         "Type":"String"
      },
      "subnetID2":{
         "Description":"subnet id 2",
         "Type":"String"
      },
      "subnetID3":{
         "Description":"subnet id 3",
         "Type":"String"
      },
      "AMIID":{
         "Description":"AMI id",
         "Type":"String"
      },
      "ApplicationName":{
         "Description":"csye6225-webapp",
         "Default":"csye6225-webapp",
         "Type":"String"
      }
   },
   "Resources":{
      "circleci-ec2-ami":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "ec2:AttachVolume",
                        "ec2:AuthorizeSecurityGroupIngress",
                        "ec2:CopyImage",
                        "ec2:CreateImage",
                        "ec2:CreateKeypair",
                        "ec2:CreateSecurityGroup",
                        "ec2:CreateSnapshot",
                        "ec2:CreateTags",
                        "ec2:CreateVolume",
                        "ec2:DeleteKeyPair",
                        "ec2:DeleteSecurityGroup",
                        "ec2:DeleteSnapshot",
                        "ec2:DeleteVolume",
                        "ec2:DeregisterImage",
                        "ec2:DescribeImageAttribute",
                        "ec2:DescribeImages",
                        "ec2:DescribeInstances",
                        "ec2:DescribeInstanceStatus",
                        "ec2:DescribeRegions",
                        "ec2:DescribeSecurityGroups",
                        "ec2:DescribeSnapshots",
                        "ec2:DescribeSubnets",
                        "ec2:DescribeTags",
                        "ec2:DescribeVolumes",
                        "ec2:DetachVolume",
                        "ec2:GetPasswordData",
                        "ec2:ModifyImageAttribute",
                        "ec2:ModifyInstanceAttribute",
                        "ec2:ModifySnapshotAttribute",
                        "ec2:RegisterImage",
                        "ec2:RunInstances",
                        "ec2:StopInstances",
                        "ec2:TerminateInstances"
                     ],
                     "Resource":"*"
                  }
               ]
            },
            "Users":[
               "circleci"
            ]
         }
      },
      "CodeDeploy-EC2-S3":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Action":[
                        "s3:Get*",
                        "s3:List*",
                        "s3:Put*",
                        "s3:Delete*"
                     ],
                     "Effect":"Allow",
                     "Resource":"*"
                  }
               ]
            }
         },
         "Roles":[
            "CodeDeployEC2ServiceRole"
         ]
      }
   },
   "CircleCI-Upload-To-S3":{
      "Type":"AWS::IAM::ManagedPolicy",
      "Properties":{
         "PolicyDocument":{
            "Version":"2012-10-17",
            "Statement":[
               {
                  "Effect":"Allow",
                  "Action":[
                     "s3:GetObject",
                     "s3:PutObject"
                  ],
                  "Resource":[
                     "*"
                  ]
               }
            ]
         },
         "Users":[
            "circleci"
         ]
      }
   },
   "CirlceCI-Code-Deploy":{
      "Type":"AWS::IAM::ManagedPolicy",
      "Properties":{
         "PolicyDocument":{
            "Version":"2012-10-17",
            "Statement":[
               {
                  "Effect":"Allow",
                  "Action":[
                     "codedeploy:RegisterApplicationRevision",
                     "codedeploy:GetApplicationRevision"
                  ],
                  "Resource":[
<<<<<<< HEAD
                     "arn:aws:codedeploy:us-east-1:233571851927:application:csye6225-webapp"
=======
                     {
                        "Fn::Join":[
                           ":",
                           [
                              "arn:aws:codedeploy:us-east-1",
                              {
                                 "Ref":"AccountId"
                              },
                              "deploymentconfig:CodeDeployDefault.AllAtOnce"
                           ]
                        ]
                     }
>>>>>>> 7eb1b49e7f89530e197a8f64dabdabd515cda0b4
                  ]
               },
               {
                  "Effect":"Allow",
                  "Action":[
                     "codedeploy:CreateDeployment",
                     "codedeploy:GetDeployment"
                  ],
                  "Resource":[
                     "*"
                  ]
               },
               {
                  "Effect":"Allow",
                  "Action":[
                     "codedeploy:GetDeploymentConfig"
                  ],
                  "Resource":[
<<<<<<< HEAD
                     "arn:aws:codedeploy:us-east-1:233571851927:deploymentconfig:CodeDeployDefault.OneAtATime",
                     "arn:aws:codedeploy:us-east-1:233571851927:deploymentconfig:CodeDeployDefault.HalfAtATime",
                     "arn:aws:codedeploy:us-east-1:233571851927:deploymentconfig:CodeDeployDefault.AllAtOnce"
=======
                     {
                        "Fn::Join":[
                           ":",
                           [
                              "arn:aws:codedeploy:us-east-1",
                              {
                                 "Ref":"AccountId"
                              },
                              "deploymentconfig:CodeDeployDefault.OneAtATime"
                           ]
                        ]
                     },
                     {
                        "Fn::Join":[
                           ":",
                           [
                              "arn:aws:codedeploy:us-east-1",
                              {
                                 "Ref":"AccountId"
                              },
                              "deploymentconfig:CodeDeployDefault.HalfAtATime"
                           ]
                        ]
                     },
                     {
                        "Fn::Join":[
                           ":",
                           [
                              "arn:aws:codedeploy:us-east-1",
                              {
                                 "Ref":"AccountId"
                              },
                              "deploymentconfig:CodeDeployDefault.AllAtOnce"
                           ]
                        ]
                     }
>>>>>>> 7eb1b49e7f89530e197a8f64dabdabd515cda0b4
                  ]
               }
            ]
         },
         "Users":[
            "circleci"
         ]
      }
   },
   "myCodeDeployEC2ServiceRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
         "AssumeRolePolicyDocument":{
            "Version":"2012-10-17",
            "Statement":[
               {
                  "Effect":"Allow",
                  "Principal":{
                     "Service":[
                        "ec2.amazonaws.com"
                     ]
                  },
                  "Action":[
                     "sts:AssumeRole"
                  ]
               }
            ]
         },
         "ManagedPolicyArns":[

         ],
         "RoleName":"CodeDeployEC2ServiceRole"
      }
   },
   "myCodeDeployServiceRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
         "RoleName":"CodeDeployServiceRole",
         "AssumeRolePolicyDocument":{
            "Version":"2012-10-17",
            "Statement":[
               {
                  "Effect":"Allow",
                  "Principal":{
                     "Service":[
                        "codedeploy.amazonaws.com"
                     ]
                  },
                  "Action":[
                     "sts:AssumeRole"
                  ]
               }
            ]
         },
         "ManagedPolicyArns":[
            "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
         ]
      }
   },
   "csye6225webapp":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
         "GroupName":"csye6225webapp",
         "GroupDescription":"SG for web server",
         "SecurityGroupIngress":[
            {
               "IpProtocol":"tcp",
               "FromPort":"22",
               "ToPort":"22",
               "CidrIp":"0.0.0.0/0"
            },
            {
               "IpProtocol":"tcp",
               "FromPort":"80",
               "ToPort":"80",
               "CidrIp":"0.0.0.0/0"
            },
            {
               "IpProtocol":"tcp",
               "FromPort":"443",
               "ToPort":"443",
               "CidrIp":"0.0.0.0/0"
            }
         ],
         "VpcId":{
            "Ref":"VPCID"
         }
      }
   },
   "csye6225rds":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
         "GroupName":"db_server_sg",
         "GroupDescription":"SG for DB server",
         "SecurityGroupIngress":{
            "IpProtocol":"tcp",
            "FromPort":"3306",
            "ToPort":"3306",
            "CidrIp":"0.0.0.0/0"
         },
         "VpcId":{
            "Ref":"VPCID"
         }
      }
   },
   "MyEC2Instance":{
      "Type":"AWS::EC2::Instance",
      "Properties":{
         "ImageId":{
            "Ref":"AMIID"
         },
         "KeyName":{
            "Ref":"KeyPairName"
         },
         "InstanceType":"t2.micro",
         "IamInstanceProfile":"CodeDeployEC2ServiceRole",
         "SubnetId":{
            "Ref":"subnetID1"
         },
          
         "UserData":{
            "Fn::Base64":{
               "Fn::Join":[
                  "",
                  [
                     "#!/bin/bash -xe\n",
                     "sudo yum -y update\n",
                     "sudo systemctl start tomcat.service\n",
                     "sudo systemctl status tomcat.service\n",
                     "sudo service mysqld start\n",
                     "service mysql status\n",
                     "use mysql\n"
                  ]
               ]
            }
         },
         "SecurityGroupIds":[
            {
               "Ref":"csye6225webapp"
            }
         ],
         "BlockDeviceMappings":[
            {
               "DeviceName":"/dev/sda1",
               "Ebs":{
                  "DeleteOnTermination":"true",
                  "VolumeSize":"20",
                  "VolumeType":"gp2"
               }
            }
         ]
      }
   },
   "myDynamoDBTable":{
      "Type":"AWS::DynamoDB::Table",
      "Properties":{
         "AttributeDefinitions":[
            {
               "AttributeName":"id",
               "AttributeType":"S"
            }
         ],
         "KeySchema":[
            {
               "AttributeName":"id",
               "KeyType":"HASH"
            }
         ],
         "ProvisionedThroughput":{
            "ReadCapacityUnits":"5",
            "WriteCapacityUnits":"5"
         },
         "TableName":"csye6225"
      }
   },
   "myDBSubnet":{
      "Type":"AWS::RDS::DBSubnetGroup",
      "Properties":{
         "DBSubnetGroupDescription":"DB Private Subnet1",
         "SubnetIds":[
            {
               "Ref":"subnetID1"
            },
            {
               "Ref":"subnetID2"
            },
            {
               "Ref":"subnetID3"
            }
         ]
      }
   },
   "myCodeDepoly":{
      "Type":"AWS::CodeDeploy::Application",
      "Properties":{
         "ApplicationName":{
            "Ref":"ApplicationName"
         },
         "ComputePlatform":"Server"
      }
   },
   "myCodeDeplymentGroup":{
      "Type":"AWS::CodeDeploy::DeploymentGroup",
      "Properties":{
         "ApplicationName":{
            "Ref":"ApplicationName"
         },
<<<<<<< HEAD
         "ServiceRoleArn":"arn:aws:iam::233571851927:role/CodeDeployServiceRole",
=======
         "ServiceRoleArn":{
            "Fn::GetAtt":[
               "myCodeDeployServiceRole",
               "Arn"
            ]
         },
>>>>>>> 7eb1b49e7f89530e197a8f64dabdabd515cda0b4
         "AutoRollbackConfiguration":{
            "Enabled":true,
            "Events":[
               "DEPLOYMENT_FAILURE"
            ]
         },
         "DeploymentConfigName":"CodeDeployDefault.AllAtOnce",
         "DeploymentGroupName":"csye6225-webapp-deployment",
         "DeploymentStyle":{
            "DeploymentOption":"WITHOUT_TRAFFIC_CONTROL",
            "DeploymentType":"IN_PLACE"
         },
         "Ec2TagFilters":[
            {
               "Key":"MyEC2",
               "Type":"KEY_AND_VALUE",
               "Value":{
                  "Ref":"MyEC2Instance"
               }
            }
         ]
      }
   },
   "myDBInstance":{
      "Type":"AWS::RDS::DBInstance",
      "Properties":{
         "DBName":"csye6225",
         "Engine":"MySQL",
         "EngineVersion":"5.6.34",
         "DBSubnetGroupName":{
            "Ref":"myDBSubnet"
         },
         "AllocatedStorage":"50",
         "MasterUsername":"csye6225master",
         "MasterUserPassword":"csye6225password",
         "MultiAZ":false,
         "DBInstanceClass":"db.t2.medium",
         "PubliclyAccessible":true,
         "DBInstanceIdentifier":"csye6225-spring2019",
         "VPCSecurityGroups":[
            {
               "Fn::GetAtt":[
                  "csye6225rds",
                  "GroupId"
               ]
            }
         ]
      }
   }
}
